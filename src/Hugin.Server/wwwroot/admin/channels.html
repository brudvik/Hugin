<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hugin IRC Server - Channels</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --hugin-primary: #2c3e50; --hugin-secondary: #3498db; }
        body { background: #f8f9fa; }
        .sidebar { 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; 
            width: 250px;
            position: fixed;
            left: 0;
            top: 0;
        }
        .sidebar .nav-link { color: rgba(255,255,255,0.7); padding: 0.75rem 1.5rem; }
        .sidebar .nav-link:hover { color: white; background: rgba(255,255,255,0.1); }
        .sidebar .nav-link.active { color: white; background: var(--hugin-secondary); }
        .sidebar .nav-link i { width: 24px; }
        .main-content { margin-left: 250px; padding: 2rem; }
        .logo-text { color: white; font-size: 1.5rem; padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .channel-name { font-family: monospace; font-weight: bold; }
        .mode-badge { font-family: monospace; font-size: 0.85rem; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo-text">
            <i class="bi bi-hdd-network me-2"></i>Hugin
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/users">
                    <i class="bi bi-people me-2"></i>Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/channels">
                    <i class="bi bi-hash me-2"></i>Channels
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/operators">
                    <i class="bi bi-shield-check me-2"></i>Operators
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/config">
                    <i class="bi bi-gear me-2"></i>Configuration
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/logs">
                    <i class="bi bi-journal-text me-2"></i>Logs
                </a>
            </li>
            <li class="nav-item mt-4">
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-left me-2"></i>Logout
                </a>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-hash me-2"></i>Channels</h2>
            <div class="d-flex gap-2">
                <input type="text" id="searchInput" class="form-control" placeholder="Search channels..." style="width: 250px;">
                <input type="number" id="minUsers" class="form-control" placeholder="Min users" style="width: 120px;" min="0">
                <button class="btn btn-outline-primary" onclick="loadChannels()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Channel</th>
                                <th>Topic</th>
                                <th>Users</th>
                                <th>Modes</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="channelsTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    <div class="spinner-border spinner-border-sm me-2"></div>Loading channels...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <span id="channelCount" class="text-muted">0 channels</span>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </main>

    <!-- Channel Details Modal -->
    <div class="modal fade" id="channelModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title channel-name" id="channelModalTitle">#channel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="channelModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="editTopic()">
                        <i class="bi bi-pencil me-1"></i>Edit Topic
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearChannel()">
                        <i class="bi bi-x-circle me-1"></i>Clear Channel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Topic Modal -->
    <div class="modal fade" id="topicModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Topic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Channel: <strong id="topicChannelName"></strong></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Topic</label>
                        <textarea class="form-control" id="topicText" rows="3" maxlength="390"></textarea>
                        <small class="text-muted"><span id="topicLength">0</span>/390</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTopic()">Save Topic</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('hugin_token');
        if (!token) window.location.href = '/admin/login';

        let currentPage = 1;
        let currentChannel = null;

        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers 
                }
            });
            if (response.status === 401) {
                localStorage.removeItem('hugin_token');
                window.location.href = '/admin/login';
                return null;
            }
            return response.json();
        }

        async function loadChannels() {
            const search = document.getElementById('searchInput').value;
            const minUsers = document.getElementById('minUsers').value;
            
            let url = `/api/channels?page=${currentPage}&pageSize=50`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (minUsers) url += `&minUsers=${minUsers}`;

            const data = await fetchWithAuth(url);
            if (!data || !data.success) {
                document.getElementById('channelsTableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center py-4 text-danger">Failed to load channels</td></tr>';
                return;
            }

            const channels = data.data.items;
            const totalCount = data.data.totalCount;
            
            document.getElementById('channelCount').textContent = `${totalCount} channel${totalCount !== 1 ? 's' : ''}`;
            
            if (channels.length === 0) {
                document.getElementById('channelsTableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center py-4 text-muted">No channels found</td></tr>';
                return;
            }

            const html = channels.map(ch => `
                <tr>
                    <td>
                        <span class="channel-name text-primary">${escapeHtml(ch.name)}</span>
                        ${ch.isRegistered ? '<i class="bi bi-patch-check-fill text-success ms-1" title="Registered"></i>' : ''}
                    </td>
                    <td>
                        <span class="text-truncate d-inline-block" style="max-width: 300px;" title="${escapeHtml(ch.topic || '')}">
                            ${ch.topic ? escapeHtml(ch.topic) : '<em class="text-muted">No topic</em>'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${ch.userCount}</span>
                    </td>
                    <td>
                        <code class="mode-badge">${ch.modes || '+nt'}</code>
                    </td>
                    <td>
                        <small class="text-muted">${formatDate(ch.createdAt)}</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='showChannelDetails("${escapeHtml(ch.name)}")'>
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('channelsTableBody').innerHTML = html;
            updatePagination(data.data);
        }

        async function showChannelDetails(name) {
            // Encode channel name for URL
            const encodedName = encodeURIComponent(name);
            
            const [channelData, membersData] = await Promise.all([
                fetchWithAuth(`/api/channels/${encodedName}`),
                fetchWithAuth(`/api/channels/${encodedName}/members`)
            ]);

            if (!channelData || !channelData.success) {
                alert('Failed to load channel details');
                return;
            }

            currentChannel = channelData.data;
            const members = membersData?.data || [];
            
            document.getElementById('channelModalTitle').textContent = currentChannel.name;
            document.getElementById('channelModalBody').innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Channel Info</h6>
                        <table class="table table-sm">
                            <tr><td>Name</td><td><strong class="channel-name">${escapeHtml(currentChannel.name)}</strong></td></tr>
                            <tr><td>Modes</td><td><code>${currentChannel.modes || '+nt'}</code></td></tr>
                            <tr><td>Users</td><td>${currentChannel.userCount}</td></tr>
                            <tr><td>Created</td><td>${new Date(currentChannel.createdAt).toLocaleString()}</td></tr>
                            <tr><td>Registered</td><td>${currentChannel.isRegistered ? 'Yes' : 'No'}</td></tr>
                            ${currentChannel.founder ? `<tr><td>Founder</td><td>${escapeHtml(currentChannel.founder)}</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Topic</h6>
                        <div class="card">
                            <div class="card-body py-2">
                                ${currentChannel.topic ? `
                                    <p class="mb-1">${escapeHtml(currentChannel.topic)}</p>
                                    <small class="text-muted">Set by ${escapeHtml(currentChannel.topicSetBy || 'unknown')} on ${currentChannel.topicSetAt ? new Date(currentChannel.topicSetAt).toLocaleString() : 'unknown'}</small>
                                ` : '<em class="text-muted">No topic set</em>'}
                            </div>
                        </div>
                    </div>
                </div>
                <h6>Members (${members.length})</h6>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr><th>Prefix</th><th>Nickname</th><th>Joined</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            ${members.map(m => `
                                <tr>
                                    <td><strong class="text-primary">${m.prefixes || ''}</strong></td>
                                    <td>${escapeHtml(m.nickname)}</td>
                                    <td><small>${formatDate(m.joinedAt)}</small></td>
                                    <td>${m.isAway ? '<span class="badge bg-secondary">Away</span>' : '<span class="badge bg-success">Active</span>'}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="4" class="text-muted">No members</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('channelModal')).show();
        }

        function editTopic() {
            if (!currentChannel) return;
            document.getElementById('topicChannelName').textContent = currentChannel.name;
            document.getElementById('topicText').value = currentChannel.topic || '';
            updateTopicLength();
            bootstrap.Modal.getInstance(document.getElementById('channelModal')).hide();
            new bootstrap.Modal(document.getElementById('topicModal')).show();
        }

        function updateTopicLength() {
            document.getElementById('topicLength').textContent = document.getElementById('topicText').value.length;
        }

        async function saveTopic() {
            if (!currentChannel) return;
            const topic = document.getElementById('topicText').value;
            
            await fetchWithAuth(`/api/channels/${encodeURIComponent(currentChannel.name)}/topic`, {
                method: 'PUT',
                body: JSON.stringify({ topic })
            });
            
            bootstrap.Modal.getInstance(document.getElementById('topicModal')).hide();
            loadChannels();
        }

        async function clearChannel() {
            if (!currentChannel) return;
            const reason = prompt('Reason for clearing channel:', 'Channel cleared by administrator');
            if (reason === null) return;
            
            if (!confirm(`Are you sure you want to kick ALL users from ${currentChannel.name}?`)) return;
            
            await fetchWithAuth(`/api/channels/${encodeURIComponent(currentChannel.name)}/clear?reason=${encodeURIComponent(reason)}`, {
                method: 'POST'
            });
            
            bootstrap.Modal.getInstance(document.getElementById('channelModal')).hide();
            loadChannels();
        }

        function updatePagination(data) {
            const totalPages = data.totalPages || 1;
            let html = '';
            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                </li>`;
            }
            document.getElementById('pagination').innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadChannels();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString();
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function logout() {
            localStorage.removeItem('hugin_token');
            window.location.href = '/admin/login';
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', debounce(loadChannels, 300));
        document.getElementById('minUsers').addEventListener('input', debounce(loadChannels, 300));
        document.getElementById('topicText').addEventListener('input', updateTopicLength);

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Initial load
        loadChannels();
        
        // Auto refresh every 30 seconds
        setInterval(loadChannels, 30000);
    </script>
</body>
</html>
