<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hugin IRC Server - Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --hugin-primary: #2c3e50; --hugin-secondary: #3498db; }
        body { background: #f8f9fa; }
        .sidebar { 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; 
            width: 250px;
            position: fixed;
            left: 0;
            top: 0;
        }
        .sidebar .nav-link { color: rgba(255,255,255,0.7); padding: 0.75rem 1.5rem; }
        .sidebar .nav-link:hover { color: white; background: rgba(255,255,255,0.1); }
        .sidebar .nav-link.active { color: white; background: var(--hugin-secondary); }
        .sidebar .nav-link i { width: 24px; }
        .main-content { margin-left: 250px; padding: 2rem; }
        .logo-text { color: white; font-size: 1.5rem; padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .config-section { margin-bottom: 1.5rem; }
        .config-section h5 { color: var(--hugin-primary); border-bottom: 2px solid var(--hugin-secondary); padding-bottom: 0.5rem; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo-text">
            <i class="bi bi-hdd-network me-2"></i>Hugin
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/users">
                    <i class="bi bi-people me-2"></i>Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/channels">
                    <i class="bi bi-hash me-2"></i>Channels
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/operators">
                    <i class="bi bi-shield-check me-2"></i>Operators
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/config">
                    <i class="bi bi-gear me-2"></i>Configuration
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/logs">
                    <i class="bi bi-journal-text me-2"></i>Logs
                </a>
            </li>
            <li class="nav-item mt-4">
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-left me-2"></i>Logout
                </a>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-gear me-2"></i>Server Configuration</h2>
            <div>
                <button class="btn btn-outline-secondary me-2" onclick="loadConfig()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Reload
                </button>
                <button class="btn btn-primary" onclick="saveConfig()">
                    <i class="bi bi-check-lg me-1"></i>Save Changes
                </button>
            </div>
        </div>

        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Some configuration changes may require a server restart to take effect.
        </div>

        <ul class="nav nav-tabs mb-4" id="configTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#serverTab">Server</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#limitsTab">Limits</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#portsTab">Ports &amp; TLS</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#ratelimitsTab">Rate Limits</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#motdTab">MOTD</a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Server Settings Tab -->
            <div class="tab-pane fade show active" id="serverTab">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Server Name</label>
                                    <input type="text" class="form-control" id="serverName" placeholder="irc.example.com">
                                    <small class="text-muted">Fully qualified domain name of your server</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Network Name</label>
                                    <input type="text" class="form-control" id="networkName" placeholder="ExampleNet">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <input type="text" class="form-control" id="description" placeholder="A friendly IRC network">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Admin Email</label>
                                    <input type="email" class="form-control" id="adminEmail" placeholder="admin@example.com">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Max Users</label>
                                    <input type="number" class="form-control" id="maxUsers" min="1" max="100000">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Limits Tab -->
            <div class="tab-pane fade" id="limitsTab">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Max Nick Length</label>
                                    <input type="number" class="form-control" id="maxNickLength" min="9" max="50">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Max Channel Length</label>
                                    <input type="number" class="form-control" id="maxChannelLength" min="50" max="200">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Max Topic Length</label>
                                    <input type="number" class="form-control" id="maxTopicLength" min="100" max="1000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Max Channels Per User</label>
                                    <input type="number" class="form-control" id="maxChannelsPerUser" min="1" max="1000">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-secondary">
                                    <h6>Default Limits</h6>
                                    <small>
                                        Nick: 30 characters<br>
                                        Channel: 50 characters<br>
                                        Topic: 390 characters<br>
                                        Channels/user: 50
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ports & TLS Tab -->
            <div class="tab-pane fade" id="portsTab">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Port Configuration</h5>
                                <div class="mb-3">
                                    <label class="form-label">TLS Port</label>
                                    <input type="number" class="form-control" id="tlsPort" min="1" max="65535" value="6697">
                                    <small class="text-muted">Standard IRC over TLS (recommended: 6697)</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Plaintext Port</label>
                                    <input type="number" class="form-control" id="plaintextPort" min="0" max="65535" value="0">
                                    <small class="text-muted">Set to 0 to disable. Not recommended for production.</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">WebSocket Port</label>
                                    <input type="number" class="form-control" id="webSocketPort" min="1" max="65535" value="8443">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Admin Panel Port</label>
                                    <input type="number" class="form-control" id="adminPort" min="1" max="65535" value="9443">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>TLS Certificate</h5>
                                <div class="card bg-light">
                                    <div class="card-body" id="tlsInfo">
                                        <div class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm"></div> Loading...
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary" onclick="uploadCertificate()">
                                        <i class="bi bi-upload me-1"></i>Upload Certificate
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rate Limits Tab -->
            <div class="tab-pane fade" id="ratelimitsTab">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Connections Per Minute</label>
                                    <input type="number" class="form-control" id="connectionsPerMinute" min="1" max="100">
                                    <small class="text-muted">Max new connections per IP per minute</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Messages Per Second</label>
                                    <input type="number" class="form-control" id="messagesPerSecond" min="1" max="50">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">PRIVMSGs Per Second</label>
                                    <input type="number" class="form-control" id="privmsgsPerSecond" min="1" max="20">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Joins Per Minute</label>
                                    <input type="number" class="form-control" id="joinsPerMinute" min="1" max="100">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nick Changes Per Minute</label>
                                    <input type="number" class="form-control" id="nickChangesPerMinute" min="1" max="20">
                                </div>
                                <div class="alert alert-warning mt-4">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Setting rate limits too high may make your server vulnerable to abuse.
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveRateLimits()">
                            <i class="bi bi-check-lg me-1"></i>Save Rate Limits
                        </button>
                    </div>
                </div>
            </div>

            <!-- MOTD Tab -->
            <div class="tab-pane fade" id="motdTab">
                <div class="card">
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Message of the Day</label>
                            <textarea class="form-control font-monospace" id="motdContent" rows="15" placeholder="Welcome to our IRC server!"></textarea>
                            <small class="text-muted">Displayed to users when they connect. Use plain text or ASCII art.</small>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted" id="motdLastModified">Last modified: -</small>
                            <button class="btn btn-primary" onclick="saveMotd()">
                                <i class="bi bi-check-lg me-1"></i>Save MOTD
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Certificate Upload Modal -->
    <div class="modal fade" id="certModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload TLS Certificate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Certificate File (PFX/P12)</label>
                        <input type="file" class="form-control" id="certFile" accept=".pfx,.p12">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Certificate Password</label>
                        <input type="password" class="form-control" id="certPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="doUploadCertificate()">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('hugin_token');
        if (!token) window.location.href = '/admin/login';

        let currentConfig = null;

        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers 
                }
            });
            if (response.status === 401) {
                localStorage.removeItem('hugin_token');
                window.location.href = '/admin/login';
                return null;
            }
            return response.json();
        }

        async function loadConfig() {
            const data = await fetchWithAuth('/api/config');
            if (!data || !data.success) {
                alert('Failed to load configuration');
                return;
            }

            currentConfig = data.data;
            
            // Server settings
            document.getElementById('serverName').value = currentConfig.serverName || '';
            document.getElementById('networkName').value = currentConfig.networkName || '';
            document.getElementById('description').value = currentConfig.description || '';
            document.getElementById('adminEmail').value = currentConfig.adminEmail || '';
            document.getElementById('maxUsers').value = currentConfig.maxUsers || 10000;

            // Limits
            document.getElementById('maxNickLength').value = currentConfig.maxNickLength || 30;
            document.getElementById('maxChannelLength').value = currentConfig.maxChannelLength || 50;
            document.getElementById('maxTopicLength').value = currentConfig.maxTopicLength || 390;
            document.getElementById('maxChannelsPerUser').value = currentConfig.maxChannelsPerUser || 50;

            // Ports
            document.getElementById('tlsPort').value = currentConfig.ports?.tlsPort || 6697;
            document.getElementById('plaintextPort').value = currentConfig.ports?.plaintextPort || 0;
            document.getElementById('webSocketPort').value = currentConfig.ports?.webSocketPort || 8443;
            document.getElementById('adminPort').value = currentConfig.ports?.adminPort || 9443;

            // TLS info
            updateTlsInfo(currentConfig.tls);
        }

        function updateTlsInfo(tls) {
            if (!tls) {
                document.getElementById('tlsInfo').innerHTML = '<div class="text-warning"><i class="bi bi-exclamation-triangle me-2"></i>TLS not configured</div>';
                return;
            }

            const hasValidCert = tls.hasValidCertificate;
            document.getElementById('tlsInfo').innerHTML = `
                <div class="${hasValidCert ? 'text-success' : 'text-warning'} mb-2">
                    <i class="bi bi-${hasValidCert ? 'shield-check' : 'exclamation-triangle'} me-2"></i>
                    ${hasValidCert ? 'Certificate configured' : 'No valid certificate'}
                </div>
                ${tls.certificateSubject ? `<p class="mb-1"><strong>Subject:</strong> ${escapeHtml(tls.certificateSubject)}</p>` : ''}
                ${tls.certificateExpiry ? `<p class="mb-1"><strong>Expires:</strong> ${new Date(tls.certificateExpiry).toLocaleDateString()}</p>` : ''}
                ${tls.useLetsEncrypt ? '<p class="mb-0"><span class="badge bg-success">Let\'s Encrypt</span></p>' : ''}
            `;
        }

        async function loadRateLimits() {
            const data = await fetchWithAuth('/api/config/ratelimits');
            if (!data || !data.success) return;

            const rl = data.data;
            document.getElementById('connectionsPerMinute').value = rl.connectionsPerMinute || 10;
            document.getElementById('messagesPerSecond').value = rl.messagesPerSecond || 5;
            document.getElementById('privmsgsPerSecond').value = rl.privmsgsPerSecond || 3;
            document.getElementById('joinsPerMinute').value = rl.joinsPerMinute || 10;
            document.getElementById('nickChangesPerMinute').value = rl.nickChangesPerMinute || 3;
        }

        async function loadMotd() {
            const data = await fetchWithAuth('/api/config/motd');
            if (!data || !data.success) return;

            document.getElementById('motdContent').value = data.data.content || '';
            if (data.data.lastModified) {
                document.getElementById('motdLastModified').textContent = 
                    'Last modified: ' + new Date(data.data.lastModified).toLocaleString();
            }
        }

        async function saveConfig() {
            const config = {
                serverName: document.getElementById('serverName').value,
                networkName: document.getElementById('networkName').value,
                description: document.getElementById('description').value,
                adminEmail: document.getElementById('adminEmail').value,
                maxUsers: parseInt(document.getElementById('maxUsers').value),
                maxNickLength: parseInt(document.getElementById('maxNickLength').value),
                maxChannelLength: parseInt(document.getElementById('maxChannelLength').value),
                maxTopicLength: parseInt(document.getElementById('maxTopicLength').value),
                maxChannelsPerUser: parseInt(document.getElementById('maxChannelsPerUser').value),
                ports: {
                    tlsPort: parseInt(document.getElementById('tlsPort').value),
                    plaintextPort: parseInt(document.getElementById('plaintextPort').value),
                    webSocketPort: parseInt(document.getElementById('webSocketPort').value),
                    adminPort: parseInt(document.getElementById('adminPort').value)
                },
                tls: currentConfig?.tls || {}
            };

            const result = await fetchWithAuth('/api/config', {
                method: 'PUT',
                body: JSON.stringify(config)
            });

            if (result && result.success) {
                alert('Configuration saved. Some changes may require a server restart.');
            } else {
                alert('Failed to save configuration: ' + (result?.error || 'Unknown error'));
            }
        }

        async function saveRateLimits() {
            const rateLimits = {
                connectionsPerMinute: parseInt(document.getElementById('connectionsPerMinute').value),
                messagesPerSecond: parseInt(document.getElementById('messagesPerSecond').value),
                privmsgsPerSecond: parseInt(document.getElementById('privmsgsPerSecond').value),
                joinsPerMinute: parseInt(document.getElementById('joinsPerMinute').value),
                nickChangesPerMinute: parseInt(document.getElementById('nickChangesPerMinute').value)
            };

            const result = await fetchWithAuth('/api/config/ratelimits', {
                method: 'PUT',
                body: JSON.stringify(rateLimits)
            });

            if (result && result.success) {
                alert('Rate limits saved.');
            } else {
                alert('Failed to save rate limits: ' + (result?.error || 'Unknown error'));
            }
        }

        async function saveMotd() {
            const content = document.getElementById('motdContent').value;

            const result = await fetchWithAuth('/api/config/motd', {
                method: 'PUT',
                body: JSON.stringify({ content })
            });

            if (result && result.success) {
                alert('MOTD saved.');
                loadMotd();
            } else {
                alert('Failed to save MOTD: ' + (result?.error || 'Unknown error'));
            }
        }

        function uploadCertificate() {
            new bootstrap.Modal(document.getElementById('certModal')).show();
        }

        async function doUploadCertificate() {
            const fileInput = document.getElementById('certFile');
            const password = document.getElementById('certPassword').value;

            if (!fileInput.files[0]) {
                alert('Please select a certificate file');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = btoa(String.fromCharCode(...new Uint8Array(e.target.result)));
                
                const result = await fetchWithAuth('/api/setup/tls', {
                    method: 'POST',
                    body: JSON.stringify({
                        method: 'Upload',
                        certificateBase64: base64,
                        certificatePassword: password
                    })
                });

                if (result && result.success) {
                    alert('Certificate uploaded successfully. Restart the server to apply.');
                    bootstrap.Modal.getInstance(document.getElementById('certModal')).hide();
                    loadConfig();
                } else {
                    alert('Failed to upload certificate: ' + (result?.error || 'Unknown error'));
                }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function logout() {
            localStorage.removeItem('hugin_token');
            window.location.href = '/admin/login';
        }

        // Initial load
        loadConfig();
        loadRateLimits();
        loadMotd();
    </script>
</body>
</html>
