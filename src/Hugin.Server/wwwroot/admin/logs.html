<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hugin IRC Server - Logs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --hugin-primary: #2c3e50; --hugin-secondary: #3498db; }
        body { background: #f8f9fa; }
        .sidebar { 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; 
            width: 250px;
            position: fixed;
            left: 0;
            top: 0;
        }
        .sidebar .nav-link { color: rgba(255,255,255,0.7); padding: 0.75rem 1.5rem; }
        .sidebar .nav-link:hover { color: white; background: rgba(255,255,255,0.1); }
        .sidebar .nav-link.active { color: white; background: var(--hugin-secondary); }
        .sidebar .nav-link i { width: 24px; }
        .main-content { margin-left: 250px; padding: 2rem; }
        .logo-text { color: white; font-size: 1.5rem; padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        .log-container {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .log-entry {
            padding: 0.25rem 0.75rem;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 1rem;
        }
        .log-entry:hover {
            background: #2d2d2d;
        }
        .log-timestamp {
            color: #858585;
            white-space: nowrap;
            min-width: 140px;
        }
        .log-level {
            font-weight: bold;
            min-width: 80px;
        }
        .log-level.trace { color: #858585; }
        .log-level.debug { color: #6a9955; }
        .log-level.information { color: #4fc1ff; }
        .log-level.warning { color: #dcdcaa; }
        .log-level.error { color: #f14c4c; }
        .log-level.critical { color: #f14c4c; background: #3a0000; padding: 0 4px; }
        .log-source {
            color: #ce9178;
            min-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .log-message {
            flex: 1;
            word-break: break-word;
        }
        .log-exception {
            color: #f14c4c;
            white-space: pre-wrap;
            font-size: 0.8rem;
            padding: 0.5rem;
            background: #2d0000;
            margin-top: 0.25rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo-text">
            <i class="bi bi-hdd-network me-2"></i>Hugin
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/users">
                    <i class="bi bi-people me-2"></i>Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/channels">
                    <i class="bi bi-hash me-2"></i>Channels
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/operators">
                    <i class="bi bi-shield-check me-2"></i>Operators
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/config">
                    <i class="bi bi-gear me-2"></i>Configuration
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/logs">
                    <i class="bi bi-journal-text me-2"></i>Logs
                </a>
            </li>
            <li class="nav-item mt-4">
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-left me-2"></i>Logout
                </a>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-journal-text me-2"></i>Server Logs</h2>
            <div class="d-flex gap-2">
                <select id="logLevel" class="form-select" style="width: 150px;">
                    <option value="">All Levels</option>
                    <option value="Trace">Trace</option>
                    <option value="Debug">Debug</option>
                    <option value="Information" selected>Information</option>
                    <option value="Warning">Warning</option>
                    <option value="Error">Error</option>
                    <option value="Critical">Critical</option>
                </select>
                <select id="logCount" class="form-select" style="width: 120px;">
                    <option value="50">50 entries</option>
                    <option value="100" selected>100 entries</option>
                    <option value="250">250 entries</option>
                    <option value="500">500 entries</option>
                </select>
                <div class="form-check form-switch d-flex align-items-center ms-2">
                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                    <label class="form-check-label ms-2" for="autoRefresh">Auto-refresh</label>
                </div>
                <button class="btn btn-outline-primary" onclick="loadLogs()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#recentTab" onclick="switchToRecent()">
                    <i class="bi bi-clock-history me-1"></i>Recent Logs
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#filesTab" onclick="loadLogFiles()">
                    <i class="bi bi-file-text me-1"></i>Log Files
                </a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Recent Logs Tab -->
            <div class="tab-pane fade show active" id="recentTab">
                <div class="log-container" id="logContainer" style="height: 600px; overflow-y: auto;">
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border spinner-border-sm me-2"></div>Loading logs...
                    </div>
                </div>
            </div>

            <!-- Log Files Tab -->
            <div class="tab-pane fade" id="filesTab">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>File Name</th>
                                        <th>Size</th>
                                        <th>Last Modified</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="logFilesBody">
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">
                                            Loading log files...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Log Cleanup</h6>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <label class="form-label">Keep logs for:</label>
                                <select id="cleanupDays" class="form-select">
                                    <option value="3">3 days</option>
                                    <option value="7" selected>7 days</option>
                                    <option value="14">14 days</option>
                                    <option value="30">30 days</option>
                                    <option value="90">90 days</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-danger mt-4" onclick="cleanupLogs()">
                                    <i class="bi bi-trash me-1"></i>Delete Old Logs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Log File Viewer Modal -->
    <div class="modal fade" id="logViewerModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logViewerTitle">Log File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <pre id="logViewerContent" class="m-0 p-3" style="max-height: 500px; overflow: auto; background: #1e1e1e; color: #d4d4d4;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a id="logDownloadLink" class="btn btn-primary" href="#" download>
                        <i class="bi bi-download me-1"></i>Download
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('hugin_token');
        if (!token) window.location.href = '/admin/login';

        let refreshInterval = null;

        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers 
                }
            });
            if (response.status === 401) {
                localStorage.removeItem('hugin_token');
                window.location.href = '/admin/login';
                return null;
            }
            return response.json();
        }

        async function loadLogs() {
            const level = document.getElementById('logLevel').value;
            const count = document.getElementById('logCount').value;
            
            let url = `/api/logs/recent?count=${count}`;
            if (level) url += `&level=${level}`;

            const data = await fetchWithAuth(url);
            if (!data || !data.success) {
                document.getElementById('logContainer').innerHTML = 
                    '<div class="text-center py-5 text-danger">Failed to load logs</div>';
                return;
            }

            const logs = data.data.entries;
            
            if (logs.length === 0) {
                document.getElementById('logContainer').innerHTML = 
                    '<div class="text-center py-5 text-muted">No log entries found</div>';
                return;
            }

            const html = logs.map(log => `
                <div class="log-entry">
                    <span class="log-timestamp">${formatTimestamp(log.timestamp)}</span>
                    <span class="log-level ${log.level.toLowerCase()}">${log.level}</span>
                    <span class="log-source" title="${escapeHtml(log.source || '')}">${escapeHtml(log.source || '-')}</span>
                    <div class="log-message">
                        ${escapeHtml(log.message)}
                        ${log.exception ? `<div class="log-exception">${escapeHtml(log.exception)}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('logContainer').innerHTML = html;
        }

        async function loadLogFiles() {
            const data = await fetchWithAuth('/api/logs/files');
            if (!data || !data.success) {
                document.getElementById('logFilesBody').innerHTML = 
                    '<tr><td colspan="4" class="text-center py-4 text-danger">Failed to load log files</td></tr>';
                return;
            }

            const files = data.data.files;
            
            if (files.length === 0) {
                document.getElementById('logFilesBody').innerHTML = 
                    '<tr><td colspan="4" class="text-center py-4 text-muted">No log files found</td></tr>';
                return;
            }

            const html = files.map(file => `
                <tr>
                    <td><i class="bi bi-file-text me-2"></i>${escapeHtml(file.name)}</td>
                    <td>${formatFileSize(file.sizeBytes)}</td>
                    <td>${new Date(file.lastModified).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick='viewLogFile("${escapeHtml(file.name)}")'>
                            <i class="bi bi-eye"></i>
                        </button>
                        <a class="btn btn-sm btn-outline-secondary" href="/api/logs/files/${encodeURIComponent(file.name)}/download" target="_blank">
                            <i class="bi bi-download"></i>
                        </a>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('logFilesBody').innerHTML = html;
        }

        async function viewLogFile(fileName) {
            document.getElementById('logViewerTitle').textContent = fileName;
            document.getElementById('logViewerContent').textContent = 'Loading...';
            document.getElementById('logDownloadLink').href = `/api/logs/files/${encodeURIComponent(fileName)}/download`;
            
            new bootstrap.Modal(document.getElementById('logViewerModal')).show();
            
            const data = await fetchWithAuth(`/api/logs/files/${encodeURIComponent(fileName)}?limit=65536`);
            if (!data || !data.success) {
                document.getElementById('logViewerContent').textContent = 'Failed to load log file';
                return;
            }

            let content = data.data.content;
            if (data.data.hasMore) {
                content += '\n\n... (file truncated, download for full content) ...';
            }
            
            document.getElementById('logViewerContent').textContent = content;
        }

        async function cleanupLogs() {
            const days = document.getElementById('cleanupDays').value;
            
            if (!confirm(`Are you sure you want to delete log files older than ${days} days?`)) {
                return;
            }

            const data = await fetchWithAuth(`/api/logs/files?daysToKeep=${days}`, { method: 'DELETE' });
            if (!data || !data.success) {
                alert('Failed to clean up logs');
                return;
            }

            alert(`Deleted ${data.data.deletedCount} files, freed ${formatFileSize(data.data.freedBytes)}`);
            loadLogFiles();
        }

        function switchToRecent() {
            loadLogs();
        }

        function formatTimestamp(ts) {
            return new Date(ts).toLocaleString();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function logout() {
            localStorage.removeItem('hugin_token');
            window.location.href = '/admin/login';
        }

        function updateAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            
            if (document.getElementById('autoRefresh').checked) {
                refreshInterval = setInterval(loadLogs, 5000);
            }
        }

        // Event listeners
        document.getElementById('logLevel').addEventListener('change', loadLogs);
        document.getElementById('logCount').addEventListener('change', loadLogs);
        document.getElementById('autoRefresh').addEventListener('change', updateAutoRefresh);

        // Initial load
        loadLogs();
        updateAutoRefresh();
    </script>
</body>
</html>
