<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hugin IRC Server - Operators</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --hugin-primary: #2c3e50; --hugin-secondary: #3498db; }
        body { background: #f8f9fa; }
        .sidebar { 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; 
            width: 250px;
            position: fixed;
            left: 0;
            top: 0;
        }
        .sidebar .nav-link { color: rgba(255,255,255,0.7); padding: 0.75rem 1.5rem; }
        .sidebar .nav-link:hover { color: white; background: rgba(255,255,255,0.1); }
        .sidebar .nav-link.active { color: white; background: var(--hugin-secondary); }
        .sidebar .nav-link i { width: 24px; }
        .main-content { margin-left: 250px; padding: 2rem; }
        .logo-text { color: white; font-size: 1.5rem; padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .oper-class { font-family: monospace; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo-text">
            <i class="bi bi-hdd-network me-2"></i>Hugin
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/users">
                    <i class="bi bi-people me-2"></i>Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/channels">
                    <i class="bi bi-hash me-2"></i>Channels
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/operators">
                    <i class="bi bi-shield-check me-2"></i>Operators
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/config">
                    <i class="bi bi-gear me-2"></i>Configuration
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/logs">
                    <i class="bi bi-journal-text me-2"></i>Logs
                </a>
            </li>
            <li class="nav-item mt-4">
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-left me-2"></i>Logout
                </a>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-shield-check me-2"></i>IRC Operators</h2>
            <button class="btn btn-primary" onclick="showAddOperator()">
                <i class="bi bi-plus-lg me-1"></i>Add Operator
            </button>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Configured Operators</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Hostmasks</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="operatorsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">
                                            <div class="spinner-border spinner-border-sm me-2"></div>Loading operators...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Server Bans</h5>
                        <button class="btn btn-sm btn-outline-danger" onclick="showAddBan()">
                            <i class="bi bi-plus-lg me-1"></i>Add Ban
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Type</th>
                                        <th>Mask</th>
                                        <th>Reason</th>
                                        <th>Set By</th>
                                        <th>Expires</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bansTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">
                                            Loading bans...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Operator Classes</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="text-primary">netadmin</h6>
                            <small class="text-muted">Full network administration rights. Can manage servers, operators, and all bans.</small>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-success">serveradmin</h6>
                            <small class="text-muted">Server administration rights. Can manage local bans and server settings.</small>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-warning">oper</h6>
                            <small class="text-muted">Standard operator. Can kill users, set modes, and manage channels.</small>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-secondary">helpop</h6>
                            <small class="text-muted">Helper operator. Can see user IPs and assist with issues.</small>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Ban Statistics</h5>
                    </div>
                    <div class="card-body" id="banStats">
                        <div class="d-flex justify-content-between mb-2">
                            <span>K-Lines (Local)</span>
                            <strong id="klineCount">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>G-Lines (Global)</span>
                            <strong id="glineCount">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Z-Lines (IP)</span>
                            <strong id="zlineCount">0</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Expired Today</span>
                            <strong id="expiredCount">0</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Operator Modal -->
    <div class="modal fade" id="operatorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="operatorModalTitle">Add Operator</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="operatorForm">
                        <div class="mb-3">
                            <label class="form-label">Operator Name</label>
                            <input type="text" class="form-control" id="operName" required pattern="[a-zA-Z][a-zA-Z0-9_-]*">
                            <small class="text-muted">Used for /OPER command</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="operPassword" minlength="12">
                            <small class="text-muted">Minimum 12 characters</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Operator Class</label>
                            <select class="form-select" id="operClass" required>
                                <option value="netadmin">Network Admin</option>
                                <option value="serveradmin">Server Admin</option>
                                <option value="oper" selected>Operator</option>
                                <option value="helpop">Help Operator</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Allowed Hostmasks</label>
                            <textarea class="form-control" id="operHostmasks" rows="3" placeholder="*@example.com&#10;user@*.isp.net"></textarea>
                            <small class="text-muted">One hostmask per line. Leave empty to allow all hosts.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveOperator()">Save Operator</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Ban Modal -->
    <div class="modal fade" id="banModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Server Ban</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="banForm">
                        <div class="mb-3">
                            <label class="form-label">Ban Type</label>
                            <select class="form-select" id="banType" required>
                                <option value="KLINE">K-Line (User@Host)</option>
                                <option value="GLINE">G-Line (Global User@Host)</option>
                                <option value="ZLINE">Z-Line (IP Address)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mask</label>
                            <input type="text" class="form-control" id="banMask" required placeholder="*@example.com or 192.168.1.*">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason</label>
                            <input type="text" class="form-control" id="banReason" required maxlength="300" placeholder="Reason for ban">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Duration</label>
                            <select class="form-select" id="banDuration">
                                <option value="">Permanent</option>
                                <option value="3600">1 Hour</option>
                                <option value="86400">1 Day</option>
                                <option value="604800">1 Week</option>
                                <option value="2592000">1 Month</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="saveBan()">Add Ban</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('hugin_token');
        if (!token) window.location.href = '/admin/login';

        let editingOperator = null;

        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers 
                }
            });
            if (response.status === 401) {
                localStorage.removeItem('hugin_token');
                window.location.href = '/admin/login';
                return null;
            }
            return response.json();
        }

        async function loadOperators() {
            const data = await fetchWithAuth('/api/operators');
            if (!data || !data.success) {
                document.getElementById('operatorsTableBody').innerHTML = 
                    '<tr><td colspan="5" class="text-center py-4 text-danger">Failed to load operators</td></tr>';
                return;
            }

            const operators = data.data;
            
            if (operators.length === 0) {
                document.getElementById('operatorsTableBody').innerHTML = 
                    '<tr><td colspan="5" class="text-center py-4 text-muted">No operators configured. Add your first operator!</td></tr>';
                return;
            }

            const html = operators.map(op => `
                <tr>
                    <td><strong>${escapeHtml(op.name)}</strong></td>
                    <td><span class="badge bg-primary oper-class">${escapeHtml(op.operClass)}</span></td>
                    <td>
                        ${op.hostmasks.length > 0 
                            ? op.hostmasks.slice(0, 2).map(h => `<code class="me-1">${escapeHtml(h)}</code>`).join('') + (op.hostmasks.length > 2 ? ` +${op.hostmasks.length - 2} more` : '')
                            : '<em class="text-muted">All hosts</em>'}
                    </td>
                    <td>
                        ${op.isOnline 
                            ? '<span class="badge bg-success">Online</span>' 
                            : '<span class="badge bg-secondary">Offline</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='editOperator(${JSON.stringify(op)})'>
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick='deleteOperator("${escapeHtml(op.name)}")'>
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('operatorsTableBody').innerHTML = html;
        }

        async function loadBans() {
            const data = await fetchWithAuth('/api/bans');
            if (!data || !data.success) {
                document.getElementById('bansTableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center py-4 text-danger">Failed to load bans</td></tr>';
                return;
            }

            const bans = data.data.items;
            
            if (bans.length === 0) {
                document.getElementById('bansTableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center py-4 text-muted">No active bans</td></tr>';
                return;
            }

            const html = bans.map(ban => `
                <tr>
                    <td><span class="badge bg-${getBanTypeBadge(ban.type)}">${escapeHtml(ban.type)}</span></td>
                    <td><code>${escapeHtml(ban.mask)}</code></td>
                    <td><span class="text-truncate d-inline-block" style="max-width: 150px;">${escapeHtml(ban.reason)}</span></td>
                    <td><small>${escapeHtml(ban.setBy)}</small></td>
                    <td>
                        ${ban.expiresAt 
                            ? `<small>${new Date(ban.expiresAt).toLocaleDateString()}</small>` 
                            : '<em class="text-muted">Never</em>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick='removeBan("${escapeHtml(ban.id)}")'>
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('bansTableBody').innerHTML = html;
        }

        async function loadBanStats() {
            const data = await fetchWithAuth('/api/bans/stats');
            if (data && data.success) {
                const stats = data.data;
                document.getElementById('klineCount').textContent = stats.activeKLines;
                document.getElementById('glineCount').textContent = stats.activeGLines;
                document.getElementById('zlineCount').textContent = stats.activeZLines;
                document.getElementById('expiredCount').textContent = stats.expiredToday;
            }
        }

        function getBanTypeBadge(type) {
            switch (type) {
                case 'KLINE': return 'warning';
                case 'GLINE': return 'danger';
                case 'ZLINE': return 'dark';
                default: return 'secondary';
            }
        }

        function showAddOperator() {
            editingOperator = null;
            document.getElementById('operatorModalTitle').textContent = 'Add Operator';
            document.getElementById('operName').value = '';
            document.getElementById('operName').disabled = false;
            document.getElementById('operPassword').value = '';
            document.getElementById('operClass').value = 'oper';
            document.getElementById('operHostmasks').value = '';
            new bootstrap.Modal(document.getElementById('operatorModal')).show();
        }

        function editOperator(oper) {
            editingOperator = oper.name;
            document.getElementById('operatorModalTitle').textContent = 'Edit Operator';
            document.getElementById('operName').value = oper.name;
            document.getElementById('operName').disabled = true;
            document.getElementById('operPassword').value = '';
            document.getElementById('operClass').value = oper.operClass;
            document.getElementById('operHostmasks').value = oper.hostmasks.join('\n');
            new bootstrap.Modal(document.getElementById('operatorModal')).show();
        }

        async function saveOperator() {
            const name = document.getElementById('operName').value;
            const password = document.getElementById('operPassword').value;
            const operClass = document.getElementById('operClass').value;
            const hostmasks = document.getElementById('operHostmasks').value
                .split('\n')
                .map(h => h.trim())
                .filter(h => h.length > 0);

            if (!name || !operClass) {
                alert('Please fill in required fields');
                return;
            }

            if (!editingOperator && (!password || password.length < 12)) {
                alert('Password must be at least 12 characters');
                return;
            }

            const body = { name, operClass, hostmasks };
            if (password) body.password = password;

            const method = editingOperator ? 'PUT' : 'POST';
            const url = editingOperator ? `/api/operators/${encodeURIComponent(name)}` : '/api/operators';

            await fetchWithAuth(url, { method, body: JSON.stringify(body) });
            
            bootstrap.Modal.getInstance(document.getElementById('operatorModal')).hide();
            loadOperators();
        }

        async function deleteOperator(name) {
            if (!confirm(`Are you sure you want to delete operator "${name}"?`)) return;
            
            await fetchWithAuth(`/api/operators/${encodeURIComponent(name)}`, { method: 'DELETE' });
            loadOperators();
        }

        function showAddBan() {
            document.getElementById('banType').value = 'KLINE';
            document.getElementById('banMask').value = '';
            document.getElementById('banReason').value = '';
            document.getElementById('banDuration').value = '';
            new bootstrap.Modal(document.getElementById('banModal')).show();
        }

        async function saveBan() {
            const type = document.getElementById('banType').value;
            const mask = document.getElementById('banMask').value;
            const reason = document.getElementById('banReason').value;
            const duration = document.getElementById('banDuration').value;

            if (!type || !mask || !reason) {
                alert('Please fill in all required fields');
                return;
            }

            const body = { type, mask, reason };
            if (duration) body.durationSeconds = parseInt(duration);

            await fetchWithAuth('/api/bans', { method: 'POST', body: JSON.stringify(body) });
            
            bootstrap.Modal.getInstance(document.getElementById('banModal')).hide();
            loadBans();
            loadBanStats();
        }

        async function removeBan(id) {
            if (!confirm('Are you sure you want to remove this ban?')) return;
            
            await fetchWithAuth(`/api/bans/${encodeURIComponent(id)}`, { method: 'DELETE' });
            loadBans();
            loadBanStats();
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function logout() {
            localStorage.removeItem('hugin_token');
            window.location.href = '/admin/login';
        }

        // Initial load
        loadOperators();
        loadBans();
        loadBanStats();
    </script>
</body>
</html>
