<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hugin IRC Server - Users</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --hugin-primary: #2c3e50; --hugin-secondary: #3498db; }
        body { background: #f8f9fa; }
        .sidebar { 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; 
            width: 250px;
            position: fixed;
            left: 0;
            top: 0;
        }
        .sidebar .nav-link { color: rgba(255,255,255,0.7); padding: 0.75rem 1.5rem; }
        .sidebar .nav-link:hover { color: white; background: rgba(255,255,255,0.1); }
        .sidebar .nav-link.active { color: white; background: var(--hugin-secondary); }
        .sidebar .nav-link i { width: 24px; }
        .main-content { margin-left: 250px; padding: 2rem; }
        .logo-text { color: white; font-size: 1.5rem; padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .user-badge { font-size: 0.75rem; }
        .mode-badge { font-family: monospace; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo-text">
            <i class="bi bi-hdd-network me-2"></i>Hugin
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/users">
                    <i class="bi bi-people me-2"></i>Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/channels">
                    <i class="bi bi-hash me-2"></i>Channels
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/operators">
                    <i class="bi bi-shield-check me-2"></i>Operators
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/config">
                    <i class="bi bi-gear me-2"></i>Configuration
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/logs">
                    <i class="bi bi-journal-text me-2"></i>Logs
                </a>
            </li>
            <li class="nav-item mt-4">
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-left me-2"></i>Logout
                </a>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-people me-2"></i>Connected Users</h2>
            <div class="d-flex gap-2">
                <input type="text" id="searchInput" class="form-control" placeholder="Search users..." style="width: 250px;">
                <select id="filterChannel" class="form-select" style="width: 200px;">
                    <option value="">All channels</option>
                </select>
                <div class="form-check form-switch d-flex align-items-center ms-2">
                    <input class="form-check-input" type="checkbox" id="operatorsOnly">
                    <label class="form-check-label ms-2" for="operatorsOnly">Operators only</label>
                </div>
                <button class="btn btn-outline-primary" onclick="loadUsers()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nickname</th>
                                <th>Username</th>
                                <th>Hostname</th>
                                <th>Real Name</th>
                                <th>Channels</th>
                                <th>Connected</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4 text-muted">
                                    <div class="spinner-border spinner-border-sm me-2"></div>Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <span id="userCount" class="text-muted">0 users</span>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </main>

    <!-- User Details Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">User Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="sendMessage()">
                        <i class="bi bi-chat-dots me-1"></i>Send Message
                    </button>
                    <button type="button" class="btn btn-danger" onclick="killUser()">
                        <i class="bi bi-x-circle me-1"></i>Kill Connection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">To: <strong id="messageTarget"></strong></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" id="messageText" rows="3" placeholder="Enter message..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="asNotice">
                        <label class="form-check-label" for="asNotice">Send as NOTICE</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="doSendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('hugin_token');
        if (!token) window.location.href = '/admin/login';

        let currentPage = 1;
        let currentUser = null;

        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers 
                }
            });
            if (response.status === 401) {
                localStorage.removeItem('hugin_token');
                window.location.href = '/admin/login';
                return null;
            }
            return response.json();
        }

        async function loadUsers() {
            const search = document.getElementById('searchInput').value;
            const channel = document.getElementById('filterChannel').value;
            const operatorsOnly = document.getElementById('operatorsOnly').checked;
            
            let url = `/api/users?page=${currentPage}&pageSize=50`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (channel) url += `&channel=${encodeURIComponent(channel)}`;
            if (operatorsOnly) url += `&operators=true`;

            const data = await fetchWithAuth(url);
            if (!data || !data.success) {
                document.getElementById('usersTableBody').innerHTML = 
                    '<tr><td colspan="8" class="text-center py-4 text-danger">Failed to load users</td></tr>';
                return;
            }

            const users = data.data.items;
            const totalCount = data.data.totalCount;
            
            document.getElementById('userCount').textContent = `${totalCount} user${totalCount !== 1 ? 's' : ''}`;
            
            if (users.length === 0) {
                document.getElementById('usersTableBody').innerHTML = 
                    '<tr><td colspan="8" class="text-center py-4 text-muted">No users connected</td></tr>';
                return;
            }

            const html = users.map(user => `
                <tr>
                    <td>
                        <strong>${escapeHtml(user.nickname)}</strong>
                        ${user.isOperator ? '<span class="badge bg-danger user-badge ms-1">OPER</span>' : ''}
                        ${user.isAway ? '<span class="badge bg-secondary user-badge ms-1">AWAY</span>' : ''}
                    </td>
                    <td><code>${escapeHtml(user.username)}</code></td>
                    <td><small class="text-muted">${escapeHtml(user.hostname)}</small></td>
                    <td>${escapeHtml(user.realName)}</td>
                    <td>
                        ${user.channels.slice(0, 3).map(c => `<span class="badge bg-info me-1">${escapeHtml(c)}</span>`).join('')}
                        ${user.channels.length > 3 ? `<span class="text-muted">+${user.channels.length - 3} more</span>` : ''}
                    </td>
                    <td><small>${formatTimeAgo(user.connectedAt)}</small></td>
                    <td>
                        ${user.isSecure ? '<i class="bi bi-lock-fill text-success" title="TLS"></i>' : '<i class="bi bi-unlock text-warning" title="Plaintext"></i>'}
                        <code class="mode-badge ms-1">${user.modes || ''}</code>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='showUserDetails(${JSON.stringify(user).replace(/'/g, "\\'")})'}>
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('usersTableBody').innerHTML = html;
            updatePagination(data.data);
        }

        function showUserDetails(user) {
            currentUser = user;
            document.getElementById('userModalTitle').textContent = user.nickname;
            document.getElementById('userModalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Connection Info</h6>
                        <table class="table table-sm">
                            <tr><td>Nickname</td><td><strong>${escapeHtml(user.nickname)}</strong></td></tr>
                            <tr><td>Username</td><td><code>${escapeHtml(user.username)}</code></td></tr>
                            <tr><td>Hostname</td><td><code>${escapeHtml(user.hostname)}</code></td></tr>
                            <tr><td>Real Name</td><td>${escapeHtml(user.realName)}</td></tr>
                            <tr><td>Real IP</td><td><code>${escapeHtml(user.realIp || 'Hidden')}</code></td></tr>
                            <tr><td>Account</td><td>${user.account ? escapeHtml(user.account) : '<em>Not logged in</em>'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Status</h6>
                        <table class="table table-sm">
                            <tr><td>Connected</td><td>${new Date(user.connectedAt).toLocaleString()}</td></tr>
                            <tr><td>Last Activity</td><td>${new Date(user.lastActivity).toLocaleString()}</td></tr>
                            <tr><td>Modes</td><td><code>${user.modes || 'none'}</code></td></tr>
                            <tr><td>Secure</td><td>${user.isSecure ? '<span class="text-success">Yes (TLS)</span>' : '<span class="text-warning">No</span>'}</td></tr>
                            <tr><td>Operator</td><td>${user.isOperator ? '<span class="text-danger">Yes</span>' : 'No'}</td></tr>
                            <tr><td>Away</td><td>${user.isAway ? escapeHtml(user.awayMessage) : 'No'}</td></tr>
                        </table>
                    </div>
                </div>
                <h6>Channels (${user.channels.length})</h6>
                <div class="mb-2">
                    ${user.channels.map(c => `<a href="/admin/channels?search=${encodeURIComponent(c)}" class="badge bg-info me-1 text-decoration-none">${escapeHtml(c)}</a>`).join('') || '<em>None</em>'}
                </div>
            `;
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function sendMessage() {
            if (!currentUser) return;
            document.getElementById('messageTarget').textContent = currentUser.nickname;
            document.getElementById('messageText').value = '';
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            new bootstrap.Modal(document.getElementById('messageModal')).show();
        }

        async function doSendMessage() {
            if (!currentUser) return;
            const message = document.getElementById('messageText').value.trim();
            if (!message) return alert('Please enter a message');
            
            const asNotice = document.getElementById('asNotice').checked;
            await fetchWithAuth(`/api/users/${encodeURIComponent(currentUser.nickname)}/message`, {
                method: 'POST',
                body: JSON.stringify({ message, asNotice })
            });
            
            bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
            alert('Message sent');
        }

        async function killUser() {
            if (!currentUser) return;
            const reason = prompt('Reason for kill:', 'Killed by administrator');
            if (reason === null) return;
            
            await fetchWithAuth(`/api/users/${encodeURIComponent(currentUser.nickname)}?reason=${encodeURIComponent(reason)}`, {
                method: 'DELETE'
            });
            
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            loadUsers();
        }

        function updatePagination(data) {
            const totalPages = data.totalPages || 1;
            let html = '';
            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                </li>`;
            }
            document.getElementById('pagination').innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadUsers();
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function logout() {
            localStorage.removeItem('hugin_token');
            window.location.href = '/admin/login';
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', debounce(loadUsers, 300));
        document.getElementById('filterChannel').addEventListener('change', loadUsers);
        document.getElementById('operatorsOnly').addEventListener('change', loadUsers);

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Load channels for filter dropdown
        async function loadChannels() {
            const data = await fetchWithAuth('/api/channels?pageSize=100');
            if (data && data.success) {
                const select = document.getElementById('filterChannel');
                data.data.items.forEach(ch => {
                    const option = document.createElement('option');
                    option.value = ch.name;
                    option.textContent = ch.name;
                    select.appendChild(option);
                });
            }
        }

        // Initial load
        loadUsers();
        loadChannels();
        
        // Auto refresh every 30 seconds
        setInterval(loadUsers, 30000);
    </script>
</body>
</html>
