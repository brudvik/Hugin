import{f as p}from"./chunk-LA36UFG2.js";import{Db as m,Ga as h,M as l,P as g,V as u,_b as d,bc as o,n as a,r as s,z as i}from"./chunk-UR2BHKY7.js";var f="hugin_token",n="hugin_refresh_token",c="hugin_user",N=(()=>{class r{http=u(d);router=u(p);currentUser=h(null);tokenValue=h(null);user=this.currentUser.asReadonly();isAuthenticated=m(()=>!!this.tokenValue());isAdmin=m(()=>this.currentUser()?.roles.includes("Admin")??!1);constructor(){this.loadFromStorage()}loadFromStorage(){let t=localStorage.getItem(f),e=localStorage.getItem(c);if(t&&e){this.tokenValue.set(t);try{this.currentUser.set(JSON.parse(e))}catch{this.clearAuth()}}}checkAuth(){this.tokenValue()&&this.getProfile().subscribe({error:()=>this.clearAuth()})}getToken(){return this.tokenValue()}login(t){return this.http.post(`${o.apiUrl}/auth/login`,t).pipe(l(e=>{e.success&&e.data&&this.setAuth(e.data)}),s(e=>e.success),i(()=>a(!1)))}logout(){let t=localStorage.getItem(n);t&&this.http.post(`${o.apiUrl}/auth/logout`,{refreshToken:t}).subscribe(),this.clearAuth(),this.router.navigate(["/login"])}refreshToken(){let t=localStorage.getItem(n);return t?this.http.post(`${o.apiUrl}/auth/refresh`,{refreshToken:t}).pipe(l(e=>{e.success&&e.data&&this.setAuth(e.data)}),s(e=>e.success),i(()=>(this.clearAuth(),a(!1)))):a(!1)}getProfile(){return this.http.get(`${o.apiUrl}/auth/me`).pipe(l(t=>{t.success&&t.data&&(this.currentUser.set(t.data),localStorage.setItem(c,JSON.stringify(t.data)))}),s(t=>t.data??null),i(()=>a(null)))}setAuth(t){localStorage.setItem(f,t.token),t.refreshToken&&localStorage.setItem(n,t.refreshToken);let e={id:"",username:t.displayName,displayName:t.displayName,email:"",roles:t.roles,createdAt:new Date().toISOString()};localStorage.setItem(c,JSON.stringify(e)),this.tokenValue.set(t.token),this.currentUser.set(e)}clearAuth(){localStorage.removeItem(f),localStorage.removeItem(n),localStorage.removeItem(c),this.tokenValue.set(null),this.currentUser.set(null)}static \u0275fac=function(e){return new(e||r)};static \u0275prov=g({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();export{N as a};
