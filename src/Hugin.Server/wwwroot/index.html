<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hugin IRC Server - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --hugin-primary: #2c3e50;
            --hugin-secondary: #3498db;
            --hugin-accent: #e74c3c;
        }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        .logo {
            font-size: 3rem;
            color: var(--hugin-secondary);
        }
        .btn-hugin {
            background: var(--hugin-secondary);
            border: none;
            color: white;
        }
        .btn-hugin:hover {
            background: #2980b9;
            color: white;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6c757d;
        }
        .step.active {
            background: var(--hugin-secondary);
            color: white;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .alert-api {
            font-family: monospace;
            font-size: 0.85rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-overlay.show {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-6">
                <div class="text-center text-white mb-4">
                    <i class="bi bi-hdd-network logo"></i>
                    <h1 class="h3 mt-2">Hugin IRC Server</h1>
                    <p class="text-white-50">Setup Wizard</p>
                </div>

                <div class="card">
                    <div class="card-body p-4 p-lg-5">
                        <div class="step-indicator">
                            <div class="step" data-step="1">1</div>
                            <div class="step" data-step="2">2</div>
                            <div class="step" data-step="3">3</div>
                            <div class="step" data-step="4">4</div>
                        </div>

                        <div id="alertContainer"></div>

                        <!-- Step 1: Server Settings -->
                        <div class="form-section" data-step="1">
                            <h4 class="mb-4"><i class="bi bi-gear me-2"></i>Server Settings</h4>
                            <form id="serverForm">
                                <div class="mb-3">
                                    <label for="serverName" class="form-label">Server Name</label>
                                    <input type="text" class="form-control" id="serverName" 
                                           placeholder="irc.example.com" required>
                                    <div class="form-text">The hostname clients will see when connecting</div>
                                </div>
                                <div class="mb-3">
                                    <label for="networkName" class="form-label">Network Name</label>
                                    <input type="text" class="form-control" id="networkName" 
                                           placeholder="MyNetwork" required>
                                    <div class="form-text">The name of your IRC network</div>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Server Description</label>
                                    <input type="text" class="form-control" id="description" 
                                           placeholder="A Hugin IRC Server">
                                </div>
                                <div class="mb-3">
                                    <label for="motd" class="form-label">Message of the Day (MOTD)</label>
                                    <textarea class="form-control" id="motd" rows="4" 
                                              placeholder="Welcome to the server!&#10;Please follow our rules."></textarea>
                                </div>
                                <button type="submit" class="btn btn-hugin w-100">
                                    Next <i class="bi bi-arrow-right"></i>
                                </button>
                            </form>
                        </div>

                        <!-- Step 2: Database -->
                        <div class="form-section" data-step="2">
                            <h4 class="mb-4"><i class="bi bi-database me-2"></i>Database Configuration</h4>
                            <form id="databaseForm">
                                <div class="mb-3">
                                    <label for="dbHost" class="form-label">Host</label>
                                    <input type="text" class="form-control" id="dbHost" 
                                           value="localhost" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="dbPort" class="form-label">Port</label>
                                        <input type="number" class="form-control" id="dbPort" 
                                               value="5432" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="dbName" class="form-label">Database Name</label>
                                        <input type="text" class="form-control" id="dbName" 
                                               value="hugin" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="dbUser" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="dbUser" 
                                           value="hugin" required>
                                </div>
                                <div class="mb-3">
                                    <label for="dbPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="dbPassword" required>
                                </div>
                                <button type="button" class="btn btn-outline-secondary mb-3 w-100" 
                                        onclick="testDatabase()">
                                    <i class="bi bi-check-circle me-2"></i>Test Connection
                                </button>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep()">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button type="submit" class="btn btn-hugin flex-grow-1">
                                        Next <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Step 3: TLS Certificate -->
                        <div class="form-section" data-step="3">
                            <h4 class="mb-4"><i class="bi bi-shield-lock me-2"></i>TLS Certificate</h4>
                            <form id="tlsForm">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    A TLS certificate is required for secure connections. You can generate a 
                                    self-signed certificate for testing or provide your own.
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tlsOption" 
                                               id="tlsGenerate" value="generate" checked>
                                        <label class="form-check-label" for="tlsGenerate">
                                            Generate self-signed certificate (for testing)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tlsOption" 
                                               id="tlsProvide" value="provide">
                                        <label class="form-check-label" for="tlsProvide">
                                            I have my own certificate
                                        </label>
                                    </div>
                                </div>
                                <div id="tlsGenerateOptions">
                                    <div class="mb-3">
                                        <label for="tlsCN" class="form-label">Common Name (CN)</label>
                                        <input type="text" class="form-control" id="tlsCN" 
                                               placeholder="localhost">
                                        <div class="form-text">Usually your server's hostname</div>
                                    </div>
                                </div>
                                <div id="tlsProvideOptions" style="display: none;">
                                    <div class="mb-3">
                                        <label for="tlsCertPath" class="form-label">Certificate Path (.pfx)</label>
                                        <input type="text" class="form-control" id="tlsCertPath" 
                                               placeholder="/path/to/certificate.pfx">
                                    </div>
                                    <div class="mb-3">
                                        <label for="tlsCertPassword" class="form-label">Certificate Password</label>
                                        <input type="password" class="form-control" id="tlsCertPassword">
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep()">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button type="submit" class="btn btn-hugin flex-grow-1">
                                        Next <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Step 4: Admin Account -->
                        <div class="form-section" data-step="4">
                            <h4 class="mb-4"><i class="bi bi-person-badge me-2"></i>Admin Account</h4>
                            <form id="adminForm">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Create an admin account to manage your IRC server. Keep these credentials safe!
                                </div>
                                <div class="mb-3">
                                    <label for="adminUsername" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="adminUsername" 
                                           placeholder="admin" pattern="^[a-zA-Z][a-zA-Z0-9_\-]*$"
                                           minlength="3" maxlength="50" required>
                                    <div class="form-text">Letters, numbers, underscore and dash. Must start with a letter.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="adminEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="adminEmail" 
                                           placeholder="admin@example.com" required>
                                </div>
                                <div class="mb-3">
                                    <label for="adminPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="adminPassword" 
                                           minlength="12" required>
                                    <div class="form-text">Minimum 12 characters</div>
                                </div>
                                <div class="mb-3">
                                    <label for="adminPasswordConfirm" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="adminPasswordConfirm" 
                                           required>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep()">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button type="submit" class="btn btn-success flex-grow-1">
                                        <i class="bi bi-check-lg me-2"></i>Complete Setup
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Completion -->
                        <div class="form-section" data-step="5">
                            <div class="text-center py-4">
                                <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                                <h4 class="mt-3">Setup Complete!</h4>
                                <p class="text-muted">Your Hugin IRC Server is now configured and ready to use.</p>
                                <div class="alert alert-success text-start">
                                    <h6><i class="bi bi-info-circle me-2"></i>Next Steps:</h6>
                                    <ul class="mb-0">
                                        <li>Restart the server to apply all changes</li>
                                        <li>Connect an IRC client to port <strong>6697</strong> (TLS)</li>
                                        <li>Login to the admin panel to manage users and channels</li>
                                    </ul>
                                </div>
                                <a href="/admin/login" class="btn btn-hugin">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>Go to Admin Panel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <small class="text-white-50">
                        <a href="/api/docs" class="text-white-50">API Documentation</a> |
                        <a href="/api/status/health" class="text-white-50">Health Check</a>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        const config = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            updateStepUI();
            setupFormHandlers();
            setupTlsRadios();
            await checkSetupRequired();
        });

        async function checkSetupRequired() {
            try {
                const response = await fetch('/api/setup/required');
                const data = await response.json();
                if (!data.data.setupRequired) {
                    // Setup already complete - check if logged in
                    if (localStorage.getItem('hugin_token')) {
                        window.location.href = '/admin/dashboard';
                    } else {
                        window.location.href = '/admin/login';
                    }
                }
            } catch (e) {
                console.log('Could not check setup status:', e);
            }
        }

        function setupFormHandlers() {
            document.getElementById('serverForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                config.server = {
                    serverName: document.getElementById('serverName').value,
                    networkName: document.getElementById('networkName').value,
                    description: document.getElementById('description').value,
                    motd: document.getElementById('motd').value
                };
                
                showLoading();
                try {
                    const response = await fetch('/api/setup/server', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config.server)
                    });
                    const data = await response.json();
                    if (data.success) {
                        nextStep();
                    } else {
                        showAlert('danger', data.message || 'Failed to save server configuration');
                    }
                } catch (e) {
                    showAlert('danger', 'API Error: ' + e.message);
                } finally {
                    hideLoading();
                }
            });

            document.getElementById('databaseForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                config.database = {
                    host: document.getElementById('dbHost').value,
                    port: parseInt(document.getElementById('dbPort').value),
                    database: document.getElementById('dbName').value,
                    username: document.getElementById('dbUser').value,
                    password: document.getElementById('dbPassword').value
                };
                
                showLoading();
                try {
                    const response = await fetch('/api/setup/database', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config.database)
                    });
                    const data = await response.json();
                    if (data.success) {
                        nextStep();
                    } else {
                        showAlert('danger', data.message || 'Failed to configure database');
                    }
                } catch (e) {
                    showAlert('danger', 'API Error: ' + e.message);
                } finally {
                    hideLoading();
                }
            });

            document.getElementById('tlsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const option = document.querySelector('input[name="tlsOption"]:checked').value;
                
                // API expects: Method (enum: Upload=0, LetsEncrypt=1, SelfSigned=2, Skip=3)
                if (option === 'generate') {
                    config.tls = { 
                        method: 2  // SelfSigned
                    };
                } else {
                    // Upload method - need base64 encoded certificate
                    config.tls = { 
                        method: 0,  // Upload
                        certificateBase64: null, // Would need file upload
                        certificatePassword: document.getElementById('tlsCertPassword').value 
                    };
                }
                
                showLoading();
                try {
                    const response = await fetch('/api/setup/tls', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config.tls)
                    });
                    const data = await response.json();
                    if (data.success) {
                        nextStep();
                    } else {
                        showAlert('danger', data.message || 'Failed to configure TLS');
                    }
                } catch (e) {
                    showAlert('danger', 'API Error: ' + e.message);
                } finally {
                    hideLoading();
                }
            });

            document.getElementById('adminForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const password = document.getElementById('adminPassword').value;
                const confirm = document.getElementById('adminPasswordConfirm').value;
                
                if (password !== confirm) {
                    showAlert('warning', 'Passwords do not match');
                    return;
                }
                
                if (password.length < 12) {
                    showAlert('warning', 'Password must be at least 12 characters');
                    return;
                }
                
                config.admin = {
                    username: document.getElementById('adminUsername').value,
                    email: document.getElementById('adminEmail').value,
                    password: password,
                    confirmPassword: confirm
                };
                
                showLoading();
                try {
                    const response = await fetch('/api/setup/admin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config.admin)
                    });
                    const data = await response.json();
                    if (data.success) {
                        // Complete setup
                        await fetch('/api/setup/complete', { method: 'POST' });
                        nextStep();
                    } else {
                        showAlert('danger', data.message || 'Failed to create admin account');
                    }
                } catch (e) {
                    showAlert('danger', 'API Error: ' + e.message);
                } finally {
                    hideLoading();
                }
            });
        }

        function setupTlsRadios() {
            const radios = document.querySelectorAll('input[name="tlsOption"]');
            radios.forEach(radio => {
                radio.addEventListener('change', () => {
                    document.getElementById('tlsGenerateOptions').style.display = 
                        document.getElementById('tlsGenerate').checked ? 'block' : 'none';
                    document.getElementById('tlsProvideOptions').style.display = 
                        document.getElementById('tlsProvide').checked ? 'block' : 'none';
                });
            });
        }

        async function testDatabase() {
            const config = {
                host: document.getElementById('dbHost').value,
                port: parseInt(document.getElementById('dbPort').value),
                database: document.getElementById('dbName').value,
                username: document.getElementById('dbUser').value,
                password: document.getElementById('dbPassword').value
            };
            
            showLoading();
            try {
                const response = await fetch('/api/setup/database/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                if (data.success) {
                    showAlert('success', 'Database connection successful!');
                } else {
                    showAlert('danger', data.message || 'Database connection failed');
                }
            } catch (e) {
                showAlert('danger', 'API Error: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        function nextStep() {
            if (currentStep < 5) {
                currentStep++;
                updateStepUI();
                clearAlert();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
                clearAlert();
            }
        }

        function updateStepUI() {
            // Update step indicators
            document.querySelectorAll('.step').forEach(el => {
                const step = parseInt(el.dataset.step);
                el.classList.remove('active', 'completed');
                if (step === currentStep) el.classList.add('active');
                else if (step < currentStep) el.classList.add('completed');
            });
            
            // Show/hide sections
            document.querySelectorAll('.form-section').forEach(el => {
                el.classList.remove('active');
                if (parseInt(el.dataset.step) === currentStep) {
                    el.classList.add('active');
                }
            });
        }

        function showAlert(type, message) {
            document.getElementById('alertContainer').innerHTML = 
                `<div class="alert alert-${type} alert-dismissible fade show alert-api" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
        }

        function clearAlert() {
            document.getElementById('alertContainer').innerHTML = '';
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
    </script>
</body>
</html>
